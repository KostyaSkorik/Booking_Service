<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Coworking | Booking</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .card-img { height: 220px; object-fit: cover; }
        .detail-img { height: 450px; object-fit: cover; width: 100%; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-50 font-sans">

<header class="bg-white shadow-sm sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
        <h1 class="text-2xl font-bold text-indigo-600 cursor-pointer" onclick="location.reload()">Coworking Space</h1>
        <div id="auth-section"></div>
    </div>
</header>

<main class="max-w-7xl mx-auto px-4 py-8">
    <div id="main-content" class="fade-in">
        <div class="text-center py-20">
            <h2 class="text-xl text-gray-400">Загрузка площадок...</h2>
        </div>
    </div>
</main>

<script>
    const API_BASE = 'http://localhost:8080';
    let user = null;

    // 1. Проверка авторизации
    async function init() {
        try {
            const res = await fetch(`${API_BASE}/api/user/me`, { credentials: 'include' });
            if (res.ok) {
                user = await res.json();
                renderHeaderProfile();
                loadList();
            } else {
                renderLoginBtn();
            }
        } catch (e) {
            renderLoginBtn();
        }
    }

    function renderHeaderProfile() {
        document.getElementById('auth-section').innerHTML = `
            <div class="flex items-center gap-3">
                <span class="font-bold text-gray-700">${user.name}</span>
                <img src="${user.picture}" class="w-10 h-10 rounded-full border-2 border-indigo-500">
            </div>`;
    }

    function renderLoginBtn() {
        document.getElementById('auth-section').innerHTML = `
            <button onclick="window.location.href='${API_BASE}/oauth2/authorization/google'"
                    class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition">
                Войти через Google
            </button>`;
        document.getElementById('main-content').innerHTML = `
            <div class="text-center py-20">
                <h2 class="text-2xl text-gray-500 font-light">Пожалуйста, войдите, чтобы увидеть коворкинги.</h2>
            </div>`;
    }

    // 2. Список коворкингов
    async function loadList() {
        const container = document.getElementById('main-content');
        try {
            const res = await fetch(`${API_BASE}/coworking/api/all`, { credentials: 'include' });
            const data = await res.json();

            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    ${data.map(item => `
                        <div onclick="openDetails('${item.id}')"
                             class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden hover:shadow-2xl transition-all duration-300 cursor-pointer group">
                            <div class="relative">
                                <img src="${item.imageUrl}" class="w-full card-img group-hover:scale-105 transition-transform duration-500">
                                <span class="absolute top-4 right-4 bg-white/90 backdrop-blur px-3 py-1 rounded-full text-[10px] font-bold text-indigo-600 shadow-sm uppercase tracking-wider">
                                    ${item.type}
                                </span>
                            </div>
                            <div class="p-6">
                                <h2 class="text-xl font-bold text-gray-800 mb-1">${item.name}</h2>
                                <p class="text-gray-500 text-sm mb-4 line-clamp-1">${item.description}</p>
                                <div class="flex justify-between items-end border-t pt-4">
                                    <div>
                                        <p class="text-xs text-gray-400 uppercase font-bold">Вместимость</p>
                                        <p class="font-bold text-gray-700">${item.capacity} чел.</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-2xl font-black text-indigo-600">${item.pricePerHour} ₽<span class="text-xs font-normal">/час</span></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>`;
        } catch (e) {
            container.innerHTML = `<p class="text-red-500 text-center">Ошибка загрузки: ${e.message}</p>`;
        }
    }

    // 3. Детальная страница
    async function openDetails(id) {
        const container = document.getElementById('main-content');
        container.innerHTML = '<div class="text-center py-20 animate-pulse text-indigo-600">Загружаем детали...</div>';

        try {
            const res = await fetch(`${API_BASE}/coworking/api/get/${id}`, { credentials: 'include' });
            const item = await res.json();

            container.innerHTML = `
                <div class="max-w-6xl mx-auto bg-white rounded-3xl shadow-2xl overflow-hidden fade-in">
                    <div class="flex flex-col lg:flex-row">
                        <div class="lg:w-1/2 relative">
                            <button onclick="loadList()" class="absolute top-6 left-6 bg-white/90 backdrop-blur p-3 rounded-full shadow-lg hover:bg-white transition z-10">
                                <svg class="w-6 h-6 text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                            </button>
                            <img src="${item.imageUrl}" class="detail-img h-full">
                        </div>

                        <div class="lg:w-1/2 p-8 lg:p-12">
                            <div class="mb-6">
                                <span class="bg-indigo-50 text-indigo-600 px-4 py-1 rounded-full text-xs font-bold uppercase tracking-widest">${item.type}</span>
                                <h1 class="text-4xl font-black text-gray-900 mt-4 mb-2">${item.name}</h1>
                                <p class="text-gray-500 leading-relaxed">${item.description}</p>
                            </div>

                            <div class="grid grid-cols-2 gap-4 mb-8">
                                <div class="bg-gray-50 p-4 rounded-2xl">
                                    <p class="text-xs text-gray-400 font-bold uppercase mb-1">Стоимость</p>
                                    <p class="text-xl font-black text-indigo-600">${item.pricePerHour} ₽/час</p>
                                </div>
                                <div class="bg-gray-50 p-4 rounded-2xl">
                                    <p class="text-xs text-gray-400 font-bold uppercase mb-1">Места</p>
                                    <p class="text-xl font-black text-gray-800">${item.capacity} чел.</p>
                                </div>
                            </div>

                            <div class="border-t pt-8">
                                <h3 class="text-lg font-bold text-gray-800 mb-4">Выберите интервал</h3>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                                    <div>
                                        <label class="text-[10px] font-bold text-gray-400 uppercase ml-1">Начало</label>
                                        <input type="datetime-local" id="bookStart" class="w-full mt-1 p-3 bg-gray-50 border-none rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition">
                                    </div>
                                    <div>
                                        <label class="text-[10px] font-bold text-gray-400 uppercase ml-1">Конец</label>
                                        <input type="datetime-local" id="bookEnd" class="w-full mt-1 p-3 bg-gray-50 border-none rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition">
                                    </div>
                                </div>
                                <button onclick="sendBooking('${item.id}', '${item.pricePerHour}')"
                                        class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold text-lg hover:bg-indigo-700 hover:shadow-xl transition-all transform active:scale-95">
                                    Подтвердить бронирование
                                </button>
                            </div>
                        </div>
                    </div>
                </div>`;
        } catch (e) {
            container.innerHTML = `<p class="text-red-500">Ошибка: ${e.message}</p>`;
        }
    }

    async function sendBooking(coworkingId, pricePerHour) {
        // Находим элементы
        const startInput = document.getElementById('bookStart').value;
        const endInput = document.getElementById('bookEnd').value;
        // Находим кнопку, чтобы заблокировать её (используем event.target, так как вызов идет из onclick)
        const btn = event.target || document.querySelector('button[onclick^="sendBooking"]');

        if (!startInput || !endInput) {
            alert('Пожалуйста, выберите интервал времени!');
            return;
        }

        const startTime = new Date(startInput);
        const endTime = new Date(endInput);

        if (startTime >= endTime) {
            alert('Время начала должно быть раньше времени окончания!');
            return;
        }

        // UX: Блокируем кнопку и меняем текст
        const originalBtnText = btn.innerText;
        btn.disabled = true;
        btn.innerText = "Проверка доступности...";
        btn.classList.add("opacity-50", "cursor-not-allowed");

        const diffInMs = endTime - startTime;
        const diffInHours = diffInMs / (1000 * 60 * 60);
        const totalPrice = (diffInHours * pricePerHour).toFixed(2);

        const bookingDto = {
            userSub: user.sub,
            coworkingId: coworkingId,
            startTime: startInput,
            endTime: endInput,
            status: "BUSY",
            totalPrice: parseFloat(totalPrice)
        };

        try {
            const response = await fetch(`${API_BASE}/booking/api/save`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(bookingDto),
                credentials: 'include'
            });

            // Пытаемся распарсить JSON ответ (успешный или с ошибкой)
            const result = await response.json();

            if (response.ok) {
                // Статус 200 OK
                alert(`✅ Успешно! Бронь подтверждена.\nСумма: ${totalPrice} ₽`);
                loadList();
            } else if (response.status === 409) {
                // Статус 409 Conflict (Наше занятое время)
                alert(`⚠️ Ошибка бронирования:\n${result.message}`);
            } else {
                // Любая другая ошибка (500, 400 и т.д.)
                alert(`Ошибка сервера: ${result.message || response.statusText}`);
            }

        } catch (e) {
            console.error("Network error:", e);
            alert("Не удалось соединиться с сервером.");
        } finally {
            // UX: Возвращаем кнопку в исходное состояние
            btn.disabled = false;
            btn.innerText = originalBtnText;
            btn.classList.remove("opacity-50", "cursor-not-allowed");
        }
    }

    document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>